name: AI Teammate (Using Original Repo)

on:
  workflow_dispatch:
    inputs:
      config_file:
        description: 'Path to agent config (relative to original repo or your repo)'
        required: true
        default: 'agents/learning_questions.json'
      encoded_config:
        description: 'Base64-encoded JSON with dynamic params (ticket_key, initiator, etc.)'
        required: false
        type: string
      use_your_agent_config:
        description: 'Use agent config from your repo instead of original'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  actions: read

jobs:
  ai-teammate:
    runs-on: ubuntu-latest
    concurrency:
      group: ai-teammate-${{ inputs.config_file }}
      cancel-in-progress: false

    steps:
      # Step 1: Checkout ORIGINAL repository (IstiN/dmtools)
      - name: Checkout Original Repository
        uses: actions/checkout@v4
        with:
          repository: IstiN/dmtools
          ref: main
          path: original-repo
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # Step 2: Checkout YOUR repository (for agent configs if needed)
      - name: Checkout Your Repository
        if: inputs.use_your_agent_config == true
        uses: actions/checkout@v4
        with:
          path: your-repo
          sparse-checkout: |
            agents/
      
      # Step 3: Setup Java
      - name: Setup Java Environment
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '23'
      
      # Step 4: Install Cursor CLI
      - name: Install Cursor CLI
        run: |
          echo "Installing Cursor CLI..."
          curl https://cursor.com/install -fsS | bash
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          
          # Verify installation
          export PATH="$HOME/.local/bin:$PATH"
          if command -v cursor-agent >/dev/null 2>&1; then
            echo "‚úÖ cursor-agent installed"
            cursor-agent --version || echo "Version check failed"
          else
            echo "‚ùå cursor-agent not found"
            exit 1
          fi
      
      # Step 5: Install DMTools CLI (from original repo's releases)
      - name: Install DMTools CLI
        working-directory: original-repo
        run: |
          echo "Installing DMTools CLI from original repository..."
          curl -fsSL https://github.com/IstiN/dmtools/releases/latest/download/install.sh | bash
          echo "$HOME/.dmtools/bin" >> $GITHUB_PATH
          
          # Verify installation
          export PATH="$HOME/.dmtools/bin:$PATH"
          if command -v dmtools >/dev/null 2>&1; then
            echo "‚úÖ dmtools installed"
            dmtools --version || echo "Version check failed"
          else
            echo "‚ùå dmtools not found"
            exit 1
          fi
      
      # Step 6: Create dmtools.env from GitHub Secrets
      - name: Create dmtools.env from Your Secrets
        working-directory: original-repo
        run: |
          echo "Creating dmtools.env from GitHub Secrets..."
          
          # Create dmtools.env with variable placeholders
          cat > dmtools.env << 'ENV_TEMPLATE'
          # Jira Configuration
          JIRA_EMAIL=${JIRA_EMAIL}
          JIRA_API_TOKEN=${JIRA_API_TOKEN}
          JIRA_BASE_PATH=${JIRA_BASE_PATH}
          JIRA_AUTH_TYPE=${JIRA_AUTH_TYPE}
          
          # Confluence Configuration
          CONFLUENCE_EMAIL=${CONFLUENCE_EMAIL}
          CONFLUENCE_API_TOKEN=${CONFLUENCE_API_TOKEN}
          CONFLUENCE_BASE_PATH=${CONFLUENCE_BASE_PATH}
          CONFLUENCE_DEFAULT_SPACE=${CONFLUENCE_DEFAULT_SPACE}
          CONFLUENCE_GRAPHQL_PATH=${CONFLUENCE_GRAPHQL_PATH}
          
          # AI Service Configuration
          GEMINI_API_KEY=${GEMINI_API_KEY}
          DEFAULT_LLM=gemini
          GEMINI_DEFAULT_MODEL=${GEMINI_DEFAULT_MODEL}
          
          # Figma Configuration
          FIGMA_TOKEN=${FIGMA_TOKEN}
          FIGMA_BASE_PATH=${FIGMA_BASE_PATH}
          
          # GitHub Authentication
          PAT_TOKEN=${PAT_TOKEN}
          GH_TOKEN=${PAT_TOKEN}
          
          # DMTools Integration Settings
          DMTOOLS_INTEGRATIONS=jira,confluence,figma,ai,cli,file
          
          # Cursor Configuration
          CURSOR_API_KEY=${CURSOR_API_KEY}
          MODEL=sonnet-4.5
          AGENT_DISABLE_WATCHDOG=1
          ENV_TEMPLATE
          
          # Export variables for substitution
          export JIRA_EMAIL="${{ secrets.JIRA_EMAIL }}"
          export JIRA_API_TOKEN="${{ secrets.JIRA_API_TOKEN }}"
          export JIRA_BASE_PATH="${{ vars.JIRA_BASE_PATH }}"
          export JIRA_AUTH_TYPE="${{ vars.JIRA_AUTH_TYPE }}"
          export CONFLUENCE_EMAIL="${{ secrets.JIRA_EMAIL }}"
          export CONFLUENCE_API_TOKEN="${{ secrets.JIRA_API_TOKEN }}"
          export CONFLUENCE_BASE_PATH="${{ vars.CONFLUENCE_BASE_PATH }}"
          export CONFLUENCE_DEFAULT_SPACE="${{ vars.CONFLUENCE_DEFAULT_SPACE }}"
          export CONFLUENCE_GRAPHQL_PATH="${{ vars.CONFLUENCE_GRAPHQL_PATH }}"
          export GEMINI_API_KEY="${{ secrets.GEMINI_API_KEY }}"
          export GEMINI_DEFAULT_MODEL="${{ vars.GEMINI_DEFAULT_MODEL || 'gemini-2.0-flash-exp' }}"
          export FIGMA_TOKEN="${{ secrets.FIGMA_TOKEN }}"
          export FIGMA_BASE_PATH="${{ vars.FIGMA_BASE_PATH }}"
          export PAT_TOKEN="${{ secrets.PAT_TOKEN }}"
          export CURSOR_API_KEY="${{ secrets.CURSOR_API_KEY }}"
          
          # Use envsubst if available, otherwise sed
          if command -v envsubst >/dev/null 2>&1; then
            envsubst < dmtools.env > dmtools.env.tmp
            mv dmtools.env.tmp dmtools.env
          else
            # Fallback to sed (escape special characters)
            sed -i "s|\${JIRA_EMAIL}|$JIRA_EMAIL|g" dmtools.env
            sed -i "s|\${JIRA_API_TOKEN}|$JIRA_API_TOKEN|g" dmtools.env
            sed -i "s|\${JIRA_BASE_PATH}|$JIRA_BASE_PATH|g" dmtools.env
            sed -i "s|\${JIRA_AUTH_TYPE}|$JIRA_AUTH_TYPE|g" dmtools.env
            sed -i "s|\${CONFLUENCE_EMAIL}|$CONFLUENCE_EMAIL|g" dmtools.env
            sed -i "s|\${CONFLUENCE_API_TOKEN}|$CONFLUENCE_API_TOKEN|g" dmtools.env
            sed -i "s|\${CONFLUENCE_BASE_PATH}|$CONFLUENCE_BASE_PATH|g" dmtools.env
            sed -i "s|\${CONFLUENCE_DEFAULT_SPACE}|$CONFLUENCE_DEFAULT_SPACE|g" dmtools.env
            sed -i "s|\${CONFLUENCE_GRAPHQL_PATH}|$CONFLUENCE_GRAPHQL_PATH|g" dmtools.env
            sed -i "s|\${GEMINI_API_KEY}|$GEMINI_API_KEY|g" dmtools.env
            sed -i "s|\${GEMINI_DEFAULT_MODEL}|$GEMINI_DEFAULT_MODEL|g" dmtools.env
            sed -i "s|\${FIGMA_TOKEN}|$FIGMA_TOKEN|g" dmtools.env
            sed -i "s|\${FIGMA_BASE_PATH}|$FIGMA_BASE_PATH|g" dmtools.env
            sed -i "s|\${PAT_TOKEN}|$PAT_TOKEN|g" dmtools.env
            sed -i "s|\${CURSOR_API_KEY}|$CURSOR_API_KEY|g" dmtools.env
          fi
          
          # Secure the file
          chmod 600 dmtools.env
          echo "‚úÖ Created dmtools.env with your credentials"
          echo "File location: $(pwd)/dmtools.env"
          echo "First few lines (masked):"
          head -n 3 dmtools.env | sed 's/=.*/=***/'
      
      # Step 7: Copy agent config from your repo if requested
      - name: Copy Agent Config from Your Repo
        if: inputs.use_your_agent_config == true
        run: |
          CONFIG_FILE="${{ inputs.config_file }}"
          echo "Copying agent config from your repository: $CONFIG_FILE"
          
          if [ -f "your-repo/$CONFIG_FILE" ]; then
            # Create directory structure if needed
            mkdir -p "original-repo/$(dirname "$CONFIG_FILE")"
            cp "your-repo/$CONFIG_FILE" "original-repo/$CONFIG_FILE"
            echo "‚úÖ Copied agent config to original-repo/$CONFIG_FILE"
          else
            echo "‚ùå Agent config not found in your repo: your-repo/$CONFIG_FILE"
            exit 1
          fi
      
      # Step 8: Verify Agent Config Exists
      - name: Verify Agent Config
        working-directory: original-repo
        run: |
          CONFIG_FILE="${{ inputs.config_file }}"
          if [ -f "$CONFIG_FILE" ]; then
            echo "‚úÖ Agent config found: $CONFIG_FILE"
            echo "Config file size: $(wc -l < "$CONFIG_FILE") lines"
          else
            echo "‚ùå Agent config not found: $CONFIG_FILE"
            echo "Available agent configs:"
            find agents/ -name "*.json" 2>/dev/null || echo "No agents/ directory found"
            exit 1
          fi
      
      # Step 9: Run AI Teammate
      - name: Run AI Teammate
        working-directory: original-repo
        env:
          PATH: "/home/runner/.local/bin:/home/runner/.dmtools/bin:/bin:/usr/bin:$PATH"
          ENCODED_CONFIG: ${{ inputs.encoded_config }}
        run: |
          CONFIG_FILE="${{ inputs.config_file }}"
          echo "üöÄ Running AI Teammate with config: $CONFIG_FILE"
          echo "Working directory: $(pwd)"
          echo "dmtools.env location: $(pwd)/dmtools.env"
          
          # Verify dmtools can find dmtools.env
          if [ -f "dmtools.env" ]; then
            echo "‚úÖ dmtools.env exists in working directory"
          else
            echo "‚ùå dmtools.env not found in working directory"
            exit 1
          fi
          
          # Run dmtools
          if [ -n "${ENCODED_CONFIG}" ]; then
            echo "Encoded config provided"
            echo "Encoded config length: ${#ENCODED_CONFIG} characters"
            dmtools run "$CONFIG_FILE" "${ENCODED_CONFIG}"
          else
            echo "No encoded config, using defaults from config file"
            dmtools run "$CONFIG_FILE"
          fi
