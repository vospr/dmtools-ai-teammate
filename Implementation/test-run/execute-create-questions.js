/**
 * Standalone script to create questions from AI response
 * This script mimics the createQuestionsAndAssignForReview.js action
 */

// Read parameters from file (will be passed via job execution)
const params = JSON.parse(require('fs').readFileSync('job-params.json', 'utf8'));

const ticketKey = params.ticket.key;
const initiatorId = params.initiator;
const questions = params.response;

console.log("Processing ticket:", ticketKey);
console.log("Number of questions:", questions.length);

const projectKey = ticketKey.split('-')[0];
const createdTickets = [];

questions.forEach(function(question, index) {
    const summary = "[Q" + (index + 1) + "] " + (question.summary || 'Follow-up question #' + (index + 1));
    const truncatedSummary = summary.length <= 120 ? summary : summary.slice(0, 117) + '...';
    const description = (question.description || 'Follow template from instructions.') + 
        "\n\n---\n*Generated by AI Teammate*\n*Priority: " + (question.priority || 'Medium') + "*";
    
    try {
        const fieldsJson = {
            summary: truncatedSummary,
            description: description,
            issuetype: { name: "Subtask" },
            parent: { key: ticketKey }
        };
        
        if (question.priority) {
            fieldsJson.priority = { name: question.priority };
        }
        
        const result = jira_create_ticket_with_json({
            project: projectKey,
            fieldsJson: fieldsJson
        });
        
        let createdKey = null;
        if (typeof result === 'string') {
            try {
                const parsed = JSON.parse(result);
                createdKey = parsed && parsed.key ? parsed.key : null;
            } catch (e) {
                // Try to extract from string
                const match = result.match(/([A-Z]+-\d+)/);
                createdKey = match ? match[1] : null;
            }
        } else if (result && result.key) {
            createdKey = result.key;
        }
        
        if (createdKey) {
            createdTickets.push({
                summary: truncatedSummary,
                priority: question.priority,
                key: createdKey
            });
            console.log('✅ Created question subtask ' + createdKey + ' with priority ' + (question.priority || 'default') + ' for summary "' + truncatedSummary + '"');
        } else {
            console.error('⚠️ Created but key not found for: ' + truncatedSummary);
        }
    } catch (error) {
        console.error('❌ Failed to create question subtask for summary "' + truncatedSummary + '":', error);
    }
});

// Add label
try {
    jira_add_label({
        key: ticketKey,
        label: "ai_questions_asked"
    });
    console.log('✅ Added label "ai_questions_asked" to ' + ticketKey);
} catch (error) {
    console.error('❌ Failed to add label:', error);
}

// Assign to initiator
try {
    jira_assign_ticket_to({
        key: ticketKey,
        accountId: initiatorId
    });
    console.log('✅ Assigned ' + ticketKey + ' to initiator');
} catch (error) {
    console.error('❌ Failed to assign ticket:', error);
}

// Move to In Review
try {
    jira_move_to_status({
        key: ticketKey,
        statusName: "In Review"
    });
    console.log('✅ Moved ' + ticketKey + ' to In Review');
} catch (error) {
    console.error('❌ Failed to move ticket to In Review:', error);
}

console.log("\n=== Summary ===");
console.log("Created " + createdTickets.length + " sub-ticket(s)");
createdTickets.forEach(function(ticket) {
    console.log("  - " + ticket.key + ": " + ticket.summary);
});

// Return result
return {
    success: true,
    message: "Ticket " + ticketKey + " assigned, moved to In Review, created " + createdTickets.length + " question subtasks",
    createdQuestions: createdTickets
};
